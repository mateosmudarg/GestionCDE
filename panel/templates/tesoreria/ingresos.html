{% extends '../layout.html' %}
{% load static %}
{% block title %}| Ingresos{% endblock %}

{% block content %}
<div class="container-fluid px-0 px-md-3">

    <!-- Header de Ingresos -->
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
        <div class="d-flex align-items-center mb-3 mb-md-0">
            <div class="icon-wrapper bg-success rounded-circle p-3 me-3">
                <i class="bi bi-arrow-up-circle text-white fs-4"></i>
            </div>
            <div>
                <h2 class="fw-bold mb-1">Ingresos</h2>
                <p class="text-muted mb-0">Todos los movimientos de entrada de dinero</p>
            </div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'balance_tesoreria' %}" class="btn btn-outline-primary d-flex align-items-center">
                <i class="bi bi-graph-up me-2"></i> Ver Balance
            </a>
            <a href="{% url 'egresos_tesoreria' %}" class="btn btn-outline-danger d-flex align-items-center">
                <i class="bi bi-arrow-down-circle me-2"></i> Ver Egresos
            </a>
        </div>
    </div>

    <!-- Métricas Principales -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card stat-card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="stat-icon bg-success rounded-circle mx-auto mb-3">
                        <i class="bi bi-currency-dollar text-white"></i>
                    </div>
                    <h3 class="fw-bold text-success mb-1">${{ total|floatformat:2 }}</h3>
                    <p class="text-muted mb-0 small">Total Ingresos</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="card stat-card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="stat-icon bg-primary rounded-circle mx-auto mb-3">
                        <i class="bi bi-receipt text-white"></i>
                    </div>
                    <h3 class="fw-bold text-primary mb-1">{{ movimientos.count }}</h3>
                    <p class="text-muted mb-0 small">Total Transacciones</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="card stat-card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="stat-icon bg-info rounded-circle mx-auto mb-3">
                        <i class="bi bi-calendar-event text-white"></i>
                    </div>
                    <h3 class="fw-bold text-info mb-1">{{ eventos_count }}</h3>
                    <p class="text-muted mb-0 small">Eventos con Ingresos</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribución de Ingresos por Evento -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="bi bi-pie-chart-fill me-2"></i>
                        Distribución de Ingresos por Evento
                    </h5>
                </div>
                <div class="card-body">
                    {% if eventos_ingresos %}
                    <div class="chart-container">
                        <canvas id="ingresosPorEvento"></canvas>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-pie-chart display-4 text-muted mb-3"></i>
                        <p class="text-muted mb-0">No hay datos suficientes para mostrar el gráfico</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Ingresos -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light py-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                <h5 class="mb-0 d-flex align-items-center">
                    <i class="bi bi-list-ul me-2"></i>
                    Detalle de Ingresos
                </h5>
                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                    <span class="text-muted small">{{ movimientos.count }} movimientos</span>
                    <a href="{% url 'balance_tesoreria' %}" class="btn btn-success btn-sm d-flex align-items-center">
                        <i class="bi bi-plus-circle me-2"></i> Nuevo Ingreso
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <!-- Filtros Mejorados -->
            <div class="p-3 border-bottom">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-md-5">
                        <label class="form-label fw-semibold small">Buscar</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" id="filtro" class="form-control border-start-0" placeholder="Descripción, evento...">
                        </div>
                    </div>
                    
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold small">Evento</label>
                        <select id="filtroEvento" class="form-select">
                            <option value="">Todos los eventos</option>
                            {% for evento in eventos_list %}
                            <option value="{{ evento.nombre }}">{{ evento.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold small">Fecha</label>
                        <input type="date" id="filtroFecha" class="form-control">
                    </div>
                    
                    <div class="col-12 col-md-1">
                        <button id="btnLimpiarFiltros" class="btn btn-outline-secondary w-100" title="Limpiar filtros">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Descripción</th>
                            <th class="text-end">Monto</th>
                            <th class="text-center">Fecha</th>
                            <th class="text-center pe-4">Evento</th>
                        </tr>
                    </thead>
                    <tbody id="tablaMovimientos">
                        {% for mov in movimientos %}
                        <tr class="movimiento-row">
                            <td class="ps-4">
                                <div class="fw-medium">{{ mov.descripcion }}</div>
                                {% if mov.detalles %}
                                <div class="text-muted small">{{ mov.detalles }}</div>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <strong class="text-success">${{ mov.monto|floatformat:2 }}</strong>
                            </td>
                            <td class="text-center">
                                <div class="fw-medium">{{ mov.fecha|date:"d/m/Y" }}</div>
                                <div class="text-muted small">{{ mov.fecha|date:"H:i" }}</div>
                            </td>
                            <td class="text-center pe-4">
                                {% if mov.evento %}
                                <span class="badge bg-light text-dark">
                                    {{ mov.evento.nombre }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <i class="bi bi-wallet display-4 text-muted mb-3"></i>
                                <h5 class="text-muted">No hay ingresos registrados</h5>
                                <p class="text-muted mb-0">No se han realizado transacciones de entrada</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th class="ps-4">Total General</th>
                            <th class="text-end">${{ total|floatformat:2 }}</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.stat-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 12px;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.stat-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-wrapper {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.movimiento-row:hover {
    background: rgba(var(--success-rgb), 0.03);
    transition: all 0.2s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .stat-card .card-body {
        padding: 1rem;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Dark mode adjustments */
[data-bs-theme="dark"] .stat-card {
    background: var(--card-bg);
}

[data-bs-theme="dark"] .card-header.bg-light {
    background: var(--border-color) !important;
    color: var(--text);
}

[data-bs-theme="dark"] .table-light {
    background: var(--border-color) !important;
    color: var(--text);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const textColor = isDark ? '#e6eef8' : '#222';
    const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
    
    // Colores para gráficos
    const colors = {
        primary: isDark ? 'rgba(0, 102, 255, 0.8)' : 'rgba(0, 102, 255, 0.8)',
        success: isDark ? 'rgba(40, 167, 69, 0.8)' : 'rgba(40, 167, 69, 0.8)',
        info: isDark ? 'rgba(23, 162, 184, 0.8)' : 'rgba(23, 162, 184, 0.8)',
        warning: isDark ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 193, 7, 0.8)',
        pie: isDark ? [
            'rgba(40, 167, 69, 0.8)', 'rgba(0, 102, 255, 0.8)', 'rgba(23, 162, 184, 0.8)',
            'rgba(255, 193, 7, 0.8)', 'rgba(108, 117, 125, 0.8)', 'rgba(220, 53, 69, 0.8)'
        ] : [
            'rgba(40, 167, 69, 0.8)', 'rgba(0, 102, 255, 0.8)', 'rgba(23, 162, 184, 0.8)',
            'rgba(255, 193, 7, 0.8)', 'rgba(108, 117, 125, 0.8)', 'rgba(220, 53, 69, 0.8)'
        ]
    };

    // Gráfico de Ingresos por Evento
    {% if eventos_ingresos %}
    const ingresosCtx = document.getElementById('ingresosPorEvento').getContext('2d');
    new Chart(ingresosCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for evento in eventos_ingresos %}'{{ evento.nombre }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for evento in eventos_ingresos %}{{ evento.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: colors.pie,
                borderColor: isDark ? 'rgba(30, 30, 30, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: textColor,
                        padding: 15,
                        usePointStyle: true,
                        boxWidth: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return ' $' + value.toFixed(2) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    // Filtros
    const filtro = document.getElementById('filtro');
    const filtroEvento = document.getElementById('filtroEvento');
    const filtroFecha = document.getElementById('filtroFecha');
    const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');

    function aplicarFiltros() {
        const texto = filtro.value.toLowerCase().trim();
        const evento = filtroEvento.value;
        const fecha = filtroFecha.value;

        document.querySelectorAll('#tablaMovimientos .movimiento-row').forEach(row => {
            const textoRow = row.textContent.toLowerCase();
            const eventoRow = row.querySelector('td:last-child').textContent.trim();
            const fechaRow = row.querySelector('td:nth-child(3)').textContent.trim().split(' ')[0]; // Solo la fecha
            
            let mostrar = true;

            // Filtro por texto
            if (texto && !textoRow.includes(texto)) {
                mostrar = false;
            }

            // Filtro por evento
            if (evento && eventoRow !== evento) {
                mostrar = false;
            }

            // Filtro por fecha
            if (fecha) {
                const [d, m, y] = fechaRow.split('/');
                const fechaISORow = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                if (fechaISORow !== fecha) {
                    mostrar = false;
                }
            }

            row.style.display = mostrar ? '' : 'none';
        });
    }

    filtro?.addEventListener('input', aplicarFiltros);
    filtroEvento?.addEventListener('change', aplicarFiltros);
    filtroFecha?.addEventListener('change', aplicarFiltros);

    btnLimpiarFiltros?.addEventListener('click', () => {
        filtro.value = '';
        filtroEvento.value = '';
        filtroFecha.value = '';
        aplicarFiltros();
    });

    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}